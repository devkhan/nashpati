// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using AppKit;
using AVFoundation;
using CoreMedia;

namespace nashpati.skin
{
	public partial class PlayerViewController : BaseViewController
	{
		private PlaylistItem current;
		public static AVPlayer Player;

		public PlaylistItem Current
		{
			get
			{
				return current;
			}
			set
			{
				PreferenceManager.Default.GlobalPreferences.CurrentPlaying = value;
			}
		}


		public PlayerViewController (IntPtr handle) : base (handle)
		{
		}

		public override void ViewDidLoad()
		{
			base.ViewDidLoad();

			Player = new AVPlayer(
				new AVPlayerItem(
					AVAsset.FromUrl(
						NSUrl.FromFilename(
							Environment.GetEnvironmentVariable(
								"NASHPATI_SAMPLE_VIDEO_FILE") ?? "/temp/sample.mp4"))));

			Player = new AVPlayer();

			PlayerView.Player = Player;
			PlayerView.Player.AddPeriodicTimeObserver(CMTime.FromSeconds(1, 1), null, (obj) => {
				// TODO: This needs to be fixed. As the private field and the prefs object are the same object,
				// updating `At` doesn't fire the PropertyChanged event.
				if (current != null) current.At = (uint)PlayerView.Player.CurrentTime.Seconds;
			});
			if (!base.prefs.Paused) { PlayerView.Player.Play(); }

			PlayerControlsContainerView.Layer = new CoreAnimation.CALayer();
			PlayerControlsContainerView.Layer.ZPosition = 1;
			PlayerView.AddSubview(PlayerControlsContainerView);

		}

		public async override void PreferencesChanged(Preferences preferences)
		{
			base.PreferencesChanged(preferences);

			if (prefs.Paused)
			{
				PlayerView.Player.Pause();
			}
			else
			{
				PlayerView.Player.Play();
			}

			// If the new item is null, in case the player is reset.
			if (prefs.CurrentPlaying == null)
			{
				current = null;
			}

			// If the video URLs don't match and the new item is non-null.
			if (Current?.VideoUrl != prefs.CurrentPlaying.VideoUrl)
			{
				current = prefs.CurrentPlaying;
				if (Current.IsBufferable)
				{
					var item = new AVPlayerItem(
							AVAsset.FromUrl(
								NSUrl.FromFilename(Current.VideoFilePath)));
					PlayerView.Player.ReplaceCurrentItemWithPlayerItem(item);
					PlayerView.Player.Seek(CMTime.FromSeconds(Current.At, 1));
					PlayerView.Player.Play();
				}
			}
		}

	}
}
